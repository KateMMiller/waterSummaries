---
output: 
  html_document:
    fig_caption: yes
    css: www/webstyles.css
    anchor_sections: FALSE
    includes: 
      in_header: "header_manual.html" 
      after_body: "footer.html"
    self_contained: yes
title: "NETN water summary"
params:
  park: SARA # 4-letter park code
  year_start: 2006 # first year of data
  year_current: 2023 # current year of data
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.pos = "h", warning = FALSE, message = FALSE)
```

```{r libs, include = F, results = 'hide'}
library(tidyverse)
library(waterNETN)
library(leaflet)

#library(plotly)
```
```{r import, results = 'hide', cache = T}
importData()
```

```{r params}
# park = "SARA"; yr_start = 2006; yr_current = 2023;
park <- params$park
yr_start <- params$year_start
yr_current <- params$year_current
yr_prev <- yr_current - 1

site_df <- getSites(park = park)[,c("SiteCode", "SiteName", "UnitCode", "UnitName")]
site_list <- sort(unique(site_df$SiteCode))
park_name <- unique(site_df$UnitName)

source("fake_bands_legend_code.R") # for legend called legg
```

# `r park_name`  {.tabset .tabset-pills}

## Water Quality  {.tabset}

### Status {.tabset}
```{r waterband_chunk, warning = F, message = FALSE, eval = FALSE}
wbplot_DO <- 
plotWaterBands(site = sitecode, year_current = yr_current, 
               years_historic = yr_start:yr_prev, 
               parameter = "DO_mgL") 

wbplot_pH <- 
plotWaterBands(site = sitecode, year_current = yr_current, 
               years_historic = yr_start:yr_prev, 
               parameter = "pH")

wbplot_sc <- 
plotWaterBands(site = sitecode, year_current = yr_current, 
               years_historic = yr_start:yr_prev, 
               parameter = "SpCond_uScm")

wbplot_temp <- 
plotWaterBands(site = sitecode, year_current = yr_current, 
               years_historic = yr_start:yr_prev, 
               parameter = "Temp_C")

wb_plot <- 
grid.arrange(wbplot_DO, wbplot_pH, wbplot_sc, wbplot_temp, legg, 
             layout_matrix = rbind(c(1, 2),
                                   c(3, 4),
                                   c(5, 5)),
             heights = c(0.5, 0.5,  0.25),
             nrow = 3, ncol = 2)

wb_plot

```

```{r wband, warning = FALSE, message = FALSE, results = 'asis', fig.height=7, fig.width=10}
for(i in seq_along(site_list)){
  sitename <- site_df[i, "SiteName"]
  sitecode <- site_list[i]
  cat("#### ", sitename, "\n\n")
  cat("\n\n")
  cat(paste0("<h2>Historic (", yr_start, " to ", yr_prev, ") vs. Current (", yr_current, ")</h2>\n"))
  cat("\n\n")
  
  <<waterband_chunk>>
  
  cat(paste0(
  "<p style='width:960px;'>",
  'The plots above show historic ranges for ', sitename, 
   ' based on the range of measurements collected from ',
   yr_start, ' to ', yr_prev, ' for each month. The outermost band represents the
   historic maximum and minimum value collected for each month.
   The second inner band represents the 95% range of historic values
   by month. The innermost band represents the 50% range of historic
   values by month. The points represent the most 
   recent measurements collected in ', yr_current, ' by month. 
   Water quality thresholds are derived from state surface water quality 
   standards. Parameter abbreviations and additional information are
   defined in "About the Data".</p>\n\n'))
  
  cat("\n\n")
}
```
<br>
 
### Trends {.tabset}
```{r tr, warning = F, message = F, fig.height=7, fig.width=10, results = 'asis'}
sonde_params <- c("DO_mgL", "pH", "Temp_C", "SpCond_uScm")

plotTrend(park = park, years = yr_start:yr_current, parameter = sonde_params, 
          smooth = T, span = 0.5, legend_position = 'right')

cat(paste0("<p style='width:960px;'>Trends in physical water quality parameters for ", sitename, " from ",
           yr_start, " to ", yr_current, ". Points represent monthly sample measurements.", 
           " Lines represent loess smoothed trends with span 0.5.</p>"))

```


## Climate {.tabset}

### Current Year {.tabset}
#### Summary {.tabset}
<h3>Current vs. 20th Century Baseline</h3>
<details open><summary class='drop'>Temperature</summary>
```{r fig.height=7, fig.width=14}
temp_comp <- plotClimComps(park = park,years= yr_current, palette = 'red', parameter = c('tmean'),
                           legend_position = 'right', plot_title = F)
temp_anom <- plotClimAnom(park = park, years = yr_current, parameter = 'tmean',
                          legend_position = 'right')
grid.arrange(temp_comp, temp_anom, nrow = 1)
```
</details>
<br>
<details open><summary class='drop'>Precipitation</summary>
```{r fig.height=7, fig.width=14}
ppt_comp <- plotClimComps(park = park,years= yr_current, palette = 'blue', parameter = c('ppt'),
                           legend_position = 'right', plot_title = F)
ppt_anom <- plotClimAnom(park = park, years = yr_current, parameter = 'ppt',
                          legend_position = 'right')
grid.arrange(ppt_comp, ppt_anom, nrow = 1)
```
</details>
<br>
<details open><summary class='drop'>Drought Condition</summary>
```{r fig.height=7, fig.width=14}
drgt <- plotClimDrought(park = park, years = yr_current)
pptcum <- plotClimCumPrecip(park = park, years = yr_current)
grid.arrange(drgt, pptcum, nrow = 1)

```
</details>
<br>

#### Temperature {.tabset}

<h3>Current Temps. vs. 20th Century Baseline</h3>
```{r}
plotClimComps(park = park, years = yr_current, palette = c("red"), parameter = 'tmean')
```

<h3>Current Temps. vs. 20th Century Baseline</h3>
```{r}
plotClimAnom(park = park, years = yr_current, parameter = 'tmean')
```

#### Precipitation
<h3>Current Precip. vs. 20th Century Baseline</h3>
```{r}
plotClimComps(park = park, years = yr_current, palette = c("blue"), parameter= 'ppt')
```


<h3>Current Precip. vs. 20th Century Baseline</h3>
```{r}
plotClimAnom(park = park, years = yr_current, parameter = 'ppt')
```

<h3>Current Pct. Precip. vs. 20th Century Baseline</h3>
```{r}
plotClimRel(park = park, years = yr_current, parameter = 'ppt', palette = c("#1378b5"))
```

<h3>Cumulative Precip. compared to 20th Century baseline</h3>
```{r}
plotClimCumPrecip(park = park, years = yr_current, legend_position = 'right')
```

#### Drought Conditions

<h3>Current U.S. Drought Monitor Conditions </h3>
```{r}
plotClimDrought(park = park, years = yr_current)

```

### Recent Trends {.tabset}

#### Temperature

<h3>5-year Temps. vs. 20th Century Baseline</h3>
```{r}
yr1 <- yr_current-4
plotClimComps(park = park, years = yr1:yr_current, parameter = "tmean",
              palette = c('#d7191c','#fdae61','#D4D459','#51A544','#2b83ba'))
```

<h3>5-year Temps. vs. 20th Century Baseline</h3>
```{r}
plotClimAnom(park = park, years = yr1:yr_current, parameter = 'tmean')
```

#### Precipitation
<h3>5-year Precip. vs. 20th Century Baseline</h3>
```{r}
yr1 <- yr_current-5
plotClimComps(park = park, years = yr1:yr_current, parameter = "ppt",
              palette = c('#d7191c','#fdae61','#D4D459','#51A544','#2b83ba'))
```

<h3>5-year Precip. vs. 20th Century Baseline</h3>
```{r}
plotClimAnom(park = park, years = yr1:yr_current, parameter = 'ppt')
```

<h3>5-year Pct. Precip. vs. 20th Century Baseline</h3>
```{r}
plotClimRel(park = park, years = yr1:yr_current, parameter = 'ppt', palette = c("#1378b5"))
```

<h3>5-yearCumulative Precip. compared to 20th Century baseline</h3>
```{r}
plotClimCumPrecip(park = park, years = yr1:yr_current, legend_position = 'right')
```

#### Drought Conditions
<h3>5-year U.S. Drought Monitor</h3>
```{r}
plotClimDrought(park = park, years = yr1:yr_current)

```


### Long-term Trends {.tabset}

#### Temperature

<h3>Historic Temperature Trends 1900:2023</h3>
```{r}
plotClimTrend(park = park, years = 1900:yr_current, 
              parameter = c("tmin", "tmax", "tmean"), facet_param = F,
              palette = "Set2", legend_position = 'right', layers = 'lines')
```

<h3>Historic Temperature Anomalies 1900:2023</h3>
```{r}
plotClimAnom(park = park, years = 1900:yr_current, 
              parameter = c("tmean"), legend_position = 'right')
```

#### Precipitation

<h3>Historic Precipitation Trends 1900:2023</h3>
```{r}
plotClimTrend(park = park, years = 1900:yr_current, 
              parameter = c("ppt"), facet_param = F,
              palette = "Set2", legend_position = 'right', layers = 'lines')
```


<h3>Historic Precipitation Anomalies 1900:2023</h3>
```{r}
plotClimAnom(park = park, years = 1900:yr_current, 
              parameter = c("ppt"), legend_position = 'right')
```

## About the Sites
```{r leaflet, out.width="80%", message=F}
NPSbasic <- "https://atlas-stg.geoplatform.gov/styles/v1/atlas-user/ck58pyquo009v01p99xebegr9/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoiYXRsYXMtdXNlciIsImEiOiJjazFmdGx2bjQwMDAwMG5wZmYwbmJwbmE2In0.lWXK2UexpXuyVitesLdwUg"

ESRIimagery <- "http://services.arcgisonline.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"

ESRItopo <- "http://services.arcgisonline.com/arcgis/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}"

ESRINatGeo <- "http://services.arcgisonline.com/arcgis/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}"

bbox <- read.csv("boundboxes.csv") #lat/long coordinates and zoom level for each park 

# Find center coordinates of park box
long_cent <- mean(c(bbox$LongE[bbox$ParkCode == park], bbox$LongW[bbox$ParkCode == park]))
lat_cent <- mean(c(bbox$LatN[bbox$ParkCode == park], bbox$LatS[bbox$ParkCode == park]))

# Compile water sites dataframe with codes, names, lat/long coordinates, and site type
water_sites1 <- getSites(park = park)[,c("SiteCode", "SiteName", "SiteLatitude", "SiteLongitude",
                                         "site_type", "SiteDescription")]

years_active <- getEvents(park = park, years = yr_start:yr_current, active = T) |> 
  select(UnitCode, SiteCode, year) |> group_by(UnitCode, SiteCode) |> 
  summarize(year_start = first(year), year_end = last(year), .groups = 'drop')


water_sites <- left_join(water_sites1, years_active, by = c("SiteCode"))
water_sites$Link = paste0("<a href='https://doimspp.sharepoint.com/sites/NETN_Photo_Viewer/Water_Quality_Site_Photos/", 
                     water_sites$Site, ".jpg' target='_blank'>Site Photo</a>")

# Legend html generator
# Source: https://stackoverflow.com/questions/47064921/leaflet-legend-for-addawesomemarkers-function-with-icons
# Icon library changed from font-awesome to ion

markerLegendHTML <- function(IconSet) {
    # Container div:
    legendHtml <- "<div style='padding: 10px; padding-bottom: 10px;'>
    <h4 style='padding-top:0; padding-bottom:10px; margin: 0; color:#555'> Legend </h4>" #legend title

    n <- 1
    # Add each icon for ion library icons:
    for (Icon in IconSet) {
        if (Icon[["library"]] == "ion") {
        legendHtml<- 
          paste0(legendHtml,
          # marker and marker label div
          "<div style='width: auto; height: 45px; display: flex; align-items: center;'>",
          # awesome marker div
          "<div style='position: relative; display: inline-block; width: 35px; height: 45px;' 
          class='awesome-marker-icon-", Icon[["markerColor"]]," awesome-marker'>",
          # add icons and set color
          # class='ion ion-waterdrop icon-white' selects the correct library, icon, and color
          "<i style='margin-left: 4px; margin-top: 11px' class= 'ion ion-",
            Icon[["icon"]]," icon-", Icon[["iconColor"]],"'></i>",
          "</div>", # close awesome marker div
          # legend label div - use name set in IconSet
          "<div style='position: relative; display: inline-block; margin-left: 8px;'>", 
            names(IconSet)[n] ,"</div>",
          "</div>") # close marker/marker label div    
        }
        n <- n + 1
    } 
    paste0(legendHtml, "</div>")
}

# Create list of icons to use in map
IconSet <- awesomeIconList(
  "stream" = makeAwesomeIcon(icon= 'waterdrop', markerColor = 'blue', iconColor = 'white', library = "ion"),
  "lake" = makeAwesomeIcon(icon= 'waterdrop', markerColor = 'cadetblue', iconColor = 'white', library = "ion")
)

# Create leaflet map
leaflet(height = 700) %>%
    # set default view of park
    setView(lng = long_cent,
            lat = lat_cent,
            zoom = bbox$Zoom[bbox$ParkCode == park]) %>%
    # setMaxBounds(lng1 = bbox[bbox$ParkCode == parkcode,]$LongE,
    #              lng2 = bbox[bbox$ParkCode == parkcode,]$LongW,
    #              lat1 = bbox[bbox$ParkCode == parkcode,]$LatN,
    #              lat2 = bbox[bbox$ParkCode == parkcode,]$LatS) %>%
    # add map tiles
    addTiles(group="Map", urlTemplate = NPSbasic, 
             options = providerTileOptions(minZoom = bbox$minZoom[bbox$ParkCode == park])) %>%
    addTiles(group="Imagery", urlTemplate = ESRIimagery) %>%
    addTiles(group="Topo", urlTemplate = ESRItopo) %>%
    addTiles(group="NatGeo", urlTemplate = ESRINatGeo) %>%
    # add button to control map tiles
    addLayersControl(map = ., baseGroups = c("Map","Imagery","Topo", "NatGeo"),
                     options = layersControlOptions(collapsed=T)) %>%
    # add site markers 
    addAwesomeMarkers(data = water_sites, ~SiteLongitude, ~SiteLatitude, 
                      icon = ~IconSet[site_type], #style markers based on site type
                      # label on mouseover
                      label=as.character(water_sites$SiteName),
                      # popup on click
                      popup = paste0("<b>", water_sites$SiteName, "</b><br>",
                                     "<b>Type: </b>", water_sites$site_type, "<br>",
                                     "<b>Sample Period: </b>", water_sites$year_start, "&ndash;",
                                     water_sites$year_end, "<br>",
                                     water_sites$SiteDescription, "<br>",
                                     water_sites$Link
                                     )
                      ) %>%
    # add legend
    addControl(markerLegendHTML(IconSet = IconSet), position = "bottomleft")

```

```{r About_tabs, child = "About_tabs.Rmd"}

```

